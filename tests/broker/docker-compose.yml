version: '3.9'

services:

  # A PostgreSQL database for the Broker to store Pacts
  # and verification results.
  postgres:
    image: postgres:15
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -d pact -U pact' ]
      interval: 2s
      timeout: 2s
      retries: 5
    ports:
      - '5432:5432'
    networks:
      - backend
    volumes:
      - pact-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: pact
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: pact

  # The Pact Broker
  broker_app:
    # Alternatively the DiUS Pact Broker can be used:
    # image: dius/pact-broker
    #
    # As well as changing the image, the destination port will need to be changed
    # from 9292 below, and in the nginx.conf proxy_pass section
    image: pactfoundation/pact-broker:latest
    ports:
      - '80:9292'
    networks:
      - backend
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PACT_BROKER_DATABASE_ADAPTER: postgres
      PACT_BROKER_DATABASE_USERNAME: pact
      PACT_BROKER_DATABASE_PASSWORD: secret
      PACT_BROKER_DATABASE_HOST: postgres
      PACT_BROKER_DATABASE_NAME: pact
      PACT_BROKER_BASIC_AUTH_USERNAME: pactbroker
      PACT_BROKER_BASIC_AUTH_PASSWORD: pactbroker
    # The Pact Broker provides a healthcheck endpoint which we will use to wait
    # for it to become available before starting up
    healthcheck:
      test: [ 'CMD', 'wget', '-q', '--tries=1', '--spider', 'http://pactbroker:pactbroker@localhost:9292/diagnostic/status/heartbeat' ]
      interval: 1s
      timeout: 2s
      retries: 10

  # An NGINX reverse proxy in front of the Broker on port 8443, to be able to
  # terminate with SSL
  nginx:
    image: nginx:alpine
    links:
      - broker_app:broker
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl
    ports:
      - '8443:443'
    networks:
      - backend
    restart: unless-stopped
    depends_on:
      broker_app:
        condition: service_healthy

networks:
  backend:
    driver: bridge

volumes:
  pact-data:
    driver: local
